<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ランドマーク方位コンパス</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; }
  #arrow {
    font-size: 80px;
    transition: transform 0.2s linear;
    display: inline-block;
  }
</style>
</head>
<body>

<h2>ランドマーク方位コンパス</h2>

<p>現在地 → ランドマークの方向</p>
<div id="arrow">⬆️</div>

<p>
  ランドマーク：
  <select id="lmSelect">
    <option value="fujisan">富士山</option>
    <option value="skytree">スカイツリー</option>
  </select>
</p>

<button id="startBtn">コンパス使用を許可</button>

<script>
// ランドマークの位置（緯度・経度）
const landmarks = {
  fujisan: { name: "富士山", lat: 35.3606, lon: 138.7274 },
  skytree: { name: "スカイツリー", lat: 35.7100, lon: 139.8107 }
};

let currentHeading = 0;
let currentPos = null;

const arrow = document.getElementById("arrow");
const lmSelect = document.getElementById("lmSelect");

// ----------------------------
// 現在地取得
// ----------------------------
navigator.geolocation.watchPosition((pos) => {
  currentPos = {
    lat: pos.coords.latitude,
    lon: pos.coords.longitude
  };
}, console.error, { enableHighAccuracy: true });


// ----------------------------
// 2点間の方位角を計算
// ----------------------------
function bearing(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;

  const dLon = toRad(lon2 - lon1);
  const y = Math.sin(dLon) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);

  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}


// ----------------------------
// 画面の矢印を回転
// ----------------------------
function updateArrow() {
  if (!currentPos) return;

  const lm = landmarks[lmSelect.value];
  const targetBearing = bearing(currentPos.lat, currentPos.lon, lm.lat, lm.lon);

  // 自分の向きに対して、ランドマークが何度の方向にあるか
  const relative = (targetBearing - currentHeading + 360) % 360;

  arrow.style.transform = `rotate(${relative}deg)`;
}

setInterval(updateArrow, 100);


// ----------------------------
// iPhone コンパス許可取得
// ----------------------------
document.getElementById("startBtn").onclick = async () => {
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const perm = await DeviceOrientationEvent.requestPermission();
    if (perm !== "granted") {
      alert("コンパス使用が許可されませんでした");
      return;
    }
  }

  window.addEventListener("deviceorientation", (e) => {
    // iOS の場合は webkitCompassHeading を優先
    if (e.webkitCompassHeading !== undefined) {
      currentHeading = e.webkitCompassHeading;
    } else {
      // 通常のデバイス（Androidなど）
      currentHeading = 360 - e.alpha;
    }
  });
};
</script>

</body>
</html>
